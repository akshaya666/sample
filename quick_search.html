<script>
  const userInput = document.getElementById('user-input');
  const sendButton = document.getElementById('send-button');
  const chatBox = document.getElementById('chat-box');
  const thumbsUp = document.getElementById('thumbs-up');
  const thumbsDown = document.getElementById('thumbs-down');
  const documentSelect = document.getElementById('document-select');
  let lastUserMessage = '';

  userInput.addEventListener('input', () => {
    sendButton.disabled = !userInput.value.trim();
  });

  userInput.addEventListener('keypress', (event) => {
    if (event.key === 'Enter' && !sendButton.disabled) {
      sendButton.click();
    }
  });

  sendButton.addEventListener('click', () => {
    const message = userInput.value.trim();
    if (message) {
      appendMessage('user', message);
      lastUserMessage = message;
      userInput.value = '';
      sendButton.disabled = true;
      fetchBotResponse(message);
    }
  });

  thumbsUp.addEventListener('click', () => {
    appendMessage('bot', 'Happy to help', true);
    disableFeedback();
  });

  thumbsDown.addEventListener('click', () => {
    appendMessage('bot', 'Looks like you are not happy with the response', true);
    fetchBotResponse(lastUserMessage);
    disableFeedback();
  });

  documentSelect.addEventListener('change', () => {
    const selectedDocument = documentSelect.value;
    fetch('/api/select_document', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ document: selectedDocument })
    })
    .then(response => response.json())
    .then(data => {
      console.log(data.message);
    })
    .catch(error => {
      console.error('Error:', error);
    });
  });

  function appendMessage(sender, message, isFeedback = false, isLoader = false) {
    const messageElem = document.createElement('div');
    messageElem.className = `message ${sender}`;
    if (isLoader) {
      messageElem.innerHTML = '<div class="dot-loader"><div></div><div></div><div></div></div>';
    } else {
      messageElem.textContent = message;
      if (sender === 'bot' && !isFeedback) {
        const copyIcon = document.createElement('i');
        copyIcon.className = 'fas fa-copy';
        copyIcon.onclick = () => {
          navigator.clipboard.writeText(message);
        };
        messageElem.appendChild(copyIcon);
      }
    }
    chatBox.appendChild(messageElem);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function fetchBotResponse(message) {
    appendMessage('bot', '', false, true);
    fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ message })
    })
    .then(response => response.json())
    .then(data => {
      const lastBotMessage = document.querySelector('.message.bot:last-child');
      if (lastBotMessage && lastBotMessage.innerHTML.includes('dot-loader')) {
        lastBotMessage.remove();
      }
      appendMessage('bot', data.message);
      enableFeedback();
    })
    .catch(error => {
      console.error('Error:', error);
    });
  }

  function enableFeedback() {
    thumbsUp.style.pointerEvents = 'auto';
    thumbsUp.style.color = 'rgba(0, 71, 123, 1)';
    thumbsDown.style.pointerEvents = 'auto';
    thumbsDown.style.color = 'rgba(0, 71, 123, 1)';
  }

  function disableFeedback() {
    thumbsUp.style.pointerEvents = 'none';
    thumbsUp.style.color = 'grey';
    thumbsDown.style.pointerEvents = 'none';
    thumbsDown.style.color = 'grey';
  }
</script>
